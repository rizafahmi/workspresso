---
import { db, Venue } from "astro:db";
import Layout from "../layouts/Layout.astro";
import { icons } from "../components/icons";

const venues = await db.select().from(Venue);
---

<Layout title="Workspresso - Find Your Workspace">
    <div class="min-h-screen bg-neutral-50">
        <div class="bg-neutral-950 text-white p-6 border-b-8 border-amber-500">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-black tracking-tight mb-2">
                        WORK<span class="text-amber-400">SPRESSO</span>
                    </h1>
                    <div
                        class="flex items-center text-gray-400 text-sm font-mono"
                    >
                        <div class="w-4 h-4 mr-2">
                            <Fragment set:html={icons.mapPin} />
                        </div>
                        <span id="venue-count">{venues.length}</span> VERIFIED VENUES
                    </div>
                </div>
                <div class="flex gap-2 items-center">
                    <a
                        href="/new"
                        class="text-xs bg-amber-500 text-neutral-900 px-3 py-2 font-bold hover:bg-amber-400 transition-colors"
                        >+ ADD</a
                    >
                    <a href="/about" class="text-xs text-gray-500 underline">
                        ABOUT
                    </a>
                </div>
            </div>
            
            <form id="search-form" class="mt-4">
                <div class="relative">
                    <input
                        type="text"
                        id="search-input"
                        name="q"
                        placeholder="Search venues..."
                        class="w-full px-4 py-3 pr-12 bg-neutral-900 border-2 border-amber-500 text-white placeholder-gray-500 font-mono focus:outline-none focus:border-amber-400"
                    />
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-amber-500">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
            </form>
        </div>

        <div id="venues-container" class="p-4 space-y-6">
            {
                venues.map((venue) => (
                    <a
                        href={`/venue/${venue.id}`}
                        class="venue-card block group bg-white border-4 border-neutral-900 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] hover:shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] hover:-translate-x-1 hover:-translate-y-1 transition-all duration-200 cursor-pointer overflow-hidden"
                    >
                        <div
                            class={`h-2 bg-gradient-to-r ${
                                venue.color === "emerald"
                                    ? "from-emerald-400 to-teal-500"
                                    : venue.color === "amber"
                                      ? "from-amber-400 to-orange-500"
                                      : venue.color === "violet"
                                        ? "from-violet-400 to-purple-500"
                                        : "from-orange-400 to-red-500"
                            }`}
                        />

                        <div class="p-5">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <h3 class="text-2xl font-black text-neutral-900 mb-1 leading-tight">
                                        {venue.name}
                                    </h3>
                                    <div class="text-sm text-neutral-600 font-mono">
                                        {venue.vibe}
                                    </div>
                                </div>
                                <div class="w-16 h-16 bg-neutral-900 text-white font-black text-3xl flex items-center justify-center border-4 border-neutral-900 -mt-2 -mr-2">
                                    {venue.grade}
                                </div>
                            </div>

                            <div class="grid grid-cols-4 gap-2 mt-4 pt-4 border-t-2 border-neutral-200">
                                <div class="text-center">
                                    <div
                                        class={`w-6 h-6 mx-auto mb-1 ${
                                            venue.wifiScore >= 4
                                                ? "text-emerald-600"
                                                : venue.wifiScore >= 3
                                                  ? "text-amber-600"
                                                  : "text-rose-600"
                                        }`}
                                    >
                                        <Fragment set:html={icons.wifi} />
                                    </div>
                                    <div class="text-xs font-black">
                                        {venue.wifiScore}/5
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div
                                        class={`w-6 h-6 mx-auto mb-1 ${
                                            venue.powerScore >= 4
                                                ? "text-emerald-600"
                                                : venue.powerScore >= 3
                                                  ? "text-amber-600"
                                                  : "text-rose-600"
                                        }`}
                                    >
                                        <Fragment set:html={icons.zap} />
                                    </div>
                                    <div class="text-xs font-black">
                                        {venue.powerScore}/5
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div
                                        class={`w-6 h-6 mx-auto mb-1 ${
                                            venue.noiseScore >= 4
                                                ? "text-emerald-600"
                                                : venue.noiseScore >= 3
                                                  ? "text-amber-600"
                                                  : "text-rose-600"
                                        }`}
                                    >
                                        <Fragment set:html={icons.volume2} />
                                    </div>
                                    <div class="text-xs font-black">
                                        {venue.noiseScore}/5
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div
                                        class={`w-6 h-6 mx-auto mb-1 ${
                                            venue.seatingScore >= 4
                                                ? "text-emerald-600"
                                                : venue.seatingScore >= 3
                                                  ? "text-amber-600"
                                                  : "text-rose-600"
                                        }`}
                                    >
                                        <Fragment set:html={icons.users} />
                                    </div>
                                    <div class="text-xs font-black">
                                        {venue.seatingScore}/5
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>
                ))
            }
        </div>
    </div>
</Layout>

<script>
	const searchInput = document.getElementById("search-input") as HTMLInputElement;
	const venuesContainer = document.getElementById("venues-container");
	const venueCount = document.getElementById("venue-count");

	let debounceTimer: number;

	searchInput?.addEventListener("input", () => {
		clearTimeout(debounceTimer);
		debounceTimer = window.setTimeout(async () => {
			const query = searchInput.value.trim();
			
			try {
				const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
				const venues = await response.json();
				
				if (venueCount) {
					venueCount.textContent = venues.length.toString();
				}

				if (venuesContainer) {
					venuesContainer.innerHTML = venues.map((venue: any) => {
						const colorClass = 
							venue.color === "emerald" ? "from-emerald-400 to-teal-500" :
							venue.color === "amber" ? "from-amber-400 to-orange-500" :
							venue.color === "violet" ? "from-violet-400 to-purple-500" :
							"from-orange-400 to-red-500";

						const getScoreColor = (score: number) => 
							score >= 4 ? "text-emerald-600" : 
							score >= 3 ? "text-amber-600" : 
							"text-rose-600";

						return `
							<a href="/venue/${venue.id}" class="venue-card block group bg-white border-4 border-neutral-900 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] hover:shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] hover:-translate-x-1 hover:-translate-y-1 transition-all duration-200 cursor-pointer overflow-hidden">
								<div class="h-2 bg-gradient-to-r ${colorClass}"></div>
								<div class="p-5">
									<div class="flex justify-between items-start mb-4">
										<div class="flex-1">
											<h3 class="text-2xl font-black text-neutral-900 mb-1 leading-tight">${venue.name}</h3>
											<div class="text-sm text-neutral-600 font-mono">${venue.vibe || ''}</div>
										</div>
										<div class="w-16 h-16 bg-neutral-900 text-white font-black text-3xl flex items-center justify-center border-4 border-neutral-900 -mt-2 -mr-2">
											${venue.grade}
										</div>
									</div>
									<div class="grid grid-cols-4 gap-2 mt-4 pt-4 border-t-2 border-neutral-200">
										<div class="text-center">
											<div class="w-6 h-6 mx-auto mb-1 ${getScoreColor(venue.wifiScore)}">
												<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h.01"></path><path d="M2 8.82a15 15 0 0 1 20 0"></path><path d="M5 12.859a10 10 0 0 1 14 0"></path><path d="M8.5 16.429a5 5 0 0 1 7 0"></path></svg>
											</div>
											<div class="text-xs font-black">${venue.wifiScore}/5</div>
										</div>
										<div class="text-center">
											<div class="w-6 h-6 mx-auto mb-1 ${getScoreColor(venue.powerScore)}">
												<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
											</div>
											<div class="text-xs font-black">${venue.powerScore}/5</div>
										</div>
										<div class="text-center">
											<div class="w-6 h-6 mx-auto mb-1 ${getScoreColor(venue.noiseScore)}">
												<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"></path><path d="M16 9a5 5 0 0 1 0 6"></path><path d="M19.364 18.364a9 9 0 0 0 0-12.728"></path></svg>
											</div>
											<div class="text-xs font-black">${venue.noiseScore}/5</div>
										</div>
										<div class="text-center">
											<div class="w-6 h-6 mx-auto mb-1 ${getScoreColor(venue.seatingScore)}">
												<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
											</div>
											<div class="text-xs font-black">${venue.seatingScore}/5</div>
										</div>
									</div>
								</div>
							</a>
						`;
					}).join('');

					if (venues.length === 0) {
						venuesContainer.innerHTML = `
							<div class="text-center py-12">
								<p class="text-neutral-600 font-mono">No venues found matching "${query}"</p>
							</div>
						`;
					}
				}
			} catch (error) {
				console.error("Search error:", error);
			}
		}, 300);
	});
</script>
