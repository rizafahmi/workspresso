---
import Layout from "../layouts/Layout.astro";
import { icons } from "../components/icons";
import { db, Venue } from "astro:db";

const message = "Help others find great work spots";

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const name = formData.get("name");
    const description = formData.get("description");
    const tags = formData.get("tags");
    const address = formData.get("address");
    const hours = formData.get("hours");
    const wifiScore = formData.get("wifiScore");
    const powerScore = formData.get("powerScore");
    const noiseScore = formData.get("noiseScore");
    const seatingScore = formData.get("seatingScore");
    const vibe = formData.get("vibe");
    const color = formData.get("color");
    const grade = formData.get("grade");

    try {
        const result = await db.insert(Venue).values({
            name,
            description,
            tags,
            address,
            hours,
            wifiScore,
            powerScore,
            noiseScore,
            seatingScore,
            vibe,
            color,
            grade,
        });

        const id = parseInt(result.lastInsertRowid);
        // updateVenueTags(id)
        return Astro.redirect(`/venue/${id}`);
    } catch (err) {
        console.error(err);
    }
}
---

<Layout title="Workspresso - Add New Venue">
    <div class="min-h-screen bg-neutral-50">
        <div class="bg-neutral-950 text-white p-6 border-b-8 border-amber-500">
            <a
                href="/"
                class="flex items-center text-white mb-4 hover:text-amber-400 transition-colors font-bold text-sm"
            >
                <span class="w-5 h-5" set:html={icons.chevronLeft} />
                BACK
            </a>
            <h1 class="text-3xl font-black tracking-tight mb-2">
                ADD NEW VENUE
            </h1>
            <p class="text-gray-400 text-sm">
                {message}
            </p>
        </div>

        <form method="POST" class="p-4 space-y-4">
            <!-- Basic Info Card -->
            <div
                class="bg-white border-4 border-neutral-900 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] overflow-hidden"
            >
                <div class="bg-neutral-900 text-white px-4 py-3">
                    <h2 class="font-black text-sm">BASIC INFORMATION</h2>
                </div>
                <div class="p-5 space-y-4">
                    <div>
                        <label
                            class="block text-xs font-bold text-neutral-500 mb-2"
                        >
                            VENUE NAME *
                        </label>
                        <input
                            type="text"
                            name="name"
                            required
                            placeholder="e.g., The Daily Grind"
                            class="w-full px-4 py-3 border-4 border-neutral-900 font-bold text-neutral-900 placeholder:text-neutral-400 focus:outline-none focus:ring-4 focus:ring-amber-500"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-xs font-bold text-neutral-500 mb-2"
                        >
                            ADDRESS *
                        </label>
                        <input
                            type="text"
                            name="address"
                            required
                            placeholder="123 Main Street, City"
                            class="w-full px-4 py-3 border-4 border-neutral-900 font-bold text-neutral-900 placeholder:text-neutral-400 focus:outline-none focus:ring-4 focus:ring-amber-500"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-xs font-bold text-neutral-500 mb-2"
                        >
                            HOURS *
                        </label>
                        <input
                            type="text"
                            name="hours"
                            required
                            placeholder="e.g., 07:00 - 09:00"
                            class="w-full px-4 py-3 border-4 border-neutral-900 font-bold text-neutral-900 font-mono placeholder:text-neutral-400 focus:outline-none focus:ring-4 focus:ring-amber-500"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-xs font-bold text-neutral-500 mb-2"
                        >
                            DESCRIPTION
                        </label>
                        <textarea
                            name="description"
                            rows="4"
                            placeholder="Describe the venue's workspace amenities, atmosphere, and what makes it unique..."
                            class="w-full px-4 py-3 border-4 border-neutral-900 font-bold text-neutral-900 placeholder:text-neutral-400 focus:outline-none focus:ring-4 focus:ring-amber-500 resize-none"
                        ></textarea>
                    </div>

                    <div>
                        <label
                            class="block text-xs font-bold text-neutral-500 mb-2"
                        >
                            TAGS
                        </label>
                        <input
                            type="text"
                            name="tags"
                            placeholder="e.g., coworking,wifi,quiet,coffee (comma-separated)"
                            class="w-full px-4 py-3 border-4 border-neutral-900 font-bold text-neutral-900 placeholder:text-neutral-400 focus:outline-none focus:ring-4 focus:ring-amber-500"
                        />
                        <p class="text-xs text-neutral-500 mt-1 font-mono">
                            Separate tags with commas (no spaces after comma)
                        </p>
                    </div>
                </div>
            </div>

            <!-- Work Environment Ratings -->
            <div
                class="bg-white border-4 border-neutral-900 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] overflow-hidden"
            >
                <div class="bg-neutral-900 text-white px-4 py-3">
                    <h2 class="font-black text-sm">WORK ENVIRONMENT RATINGS</h2>
                </div>
                <div class="p-5 space-y-6">
                    <!-- Wi-Fi Rating -->
                    <div>
                        <div class="flex items-center gap-3 mb-3">
                            <div
                                class="w-10 h-10 bg-emerald-100 flex items-center justify-center border-2 border-neutral-900"
                            >
                                <span
                                    set:html={icons.wifi}
                                    class="w-5 h5 text-emerald-700"
                                />
                            </div>
                            <div class="flex-1">
                                <label
                                    class="block text-xs font-bold text-neutral-500 mb-1"
                                >
                                    WI-FI RELIABILITY
                                </label>
                            </div>
                        </div>
                        <input
                            type="range"
                            name="wifiScore"
                            min="1"
                            max="5"
                            value="3"
                            class="w-full h-3 bg-neutral-200 appearance-none cursor-pointer accent-emerald-600"
                            style=""
                        />
                        <div
                            class="flex justify-between text-xs text-neutral-500 mt-1 font-mono"
                        >
                            <span>Unreliable</span>
                            <span>Perfect</span>
                        </div>
                    </div>

                    <!-- Power Outlets Rating -->
                    <div>
                        <div class="flex items-center gap-3 mb-3">
                            <div
                                class="w-10 h-10 bg-amber-100 flex items-center justify-center border-2 border-neutral-900"
                            >
                                <span
                                    set:html={icons.zap}
                                    class="w-5 h5 text-amber-700"
                                />
                            </div>
                            <div class="flex-1">
                                <label
                                    class="block text-xs font-bold text-neutral-500 mb-1"
                                >
                                    POWER OUTLETS
                                </label>
                            </div>
                        </div>
                        <input
                            type="range"
                            name="powerScore"
                            min="1"
                            max="5"
                            value="3"
                            class="w-full h-3 bg-neutral-200 appearance-none cursor-pointer accent-amber-600"
                            style=""
                        />
                        <div
                            class="flex justify-between text-xs text-neutral-500 mt-1 font-mono"
                        >
                            <span>Rare</span>
                            <span>Plentiful</span>
                        </div>
                    </div>

                    <!-- Noise Level Rating -->
                    <div>
                        <div class="flex items-center gap-3 mb-3">
                            <div
                                class="w-10 h-10 bg-violet-100 flex items-center justify-center border-2 border-neutral-900"
                            >
                                <span
                                    set:html={icons.volume2}
                                    class="w-5 h5 text-violet-700"
                                />
                            </div>
                            <div class="flex-1">
                                <label
                                    class="block text-xs font-bold text-neutral-500 mb-1"
                                >
                                    NOISE LEVEL
                                </label>
                            </div>
                        </div>
                        <input
                            type="range"
                            name="noiseScore"
                            min="1"
                            max="5"
                            value="3"
                            class="w-full h-3 bg-neutral-200 appearance-none cursor-pointer accent-violet-600"
                            style=""
                        />
                        <div
                            class="flex justify-between text-xs text-neutral-500 mt-1 font-mono"
                        >
                            <span>Loud</span>
                            <span>Quiet</span>
                        </div>
                    </div>

                    <!-- Seating Rating -->
                    <div>
                        <div class="flex items-center gap-3 mb-3">
                            <div
                                class="w-10 h-10 bg-blue-100 flex items-center justify-center border-2 border-neutral-900"
                            >
                                <span
                                    set:html={icons.volume2}
                                    class="w-5 h5 text-blue-700"
                                />
                            </div>
                            <div class="flex-1">
                                <label
                                    class="block text-xs font-bold text-neutral-500 mb-1"
                                >
                                    SEATING & SPACE
                                </label>
                            </div>
                        </div>
                        <input
                            type="range"
                            name="seatingScore"
                            min="1"
                            max="5"
                            value="3"
                            class="w-full h-3 bg-neutral-200 appearance-none cursor-pointer accent-blue-600"
                            style=""
                        />
                        <div
                            class="flex justify-between text-xs text-neutral-500 mt-1 font-mono"
                        >
                            <span>Loud</span>
                            <span>Quiet</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div
                class="bg-amber-100 border-4 border-neutral-900 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] p-5"
            >
                <p class="text-sm text-neutral-700 mb-4 font-medium">
                    By submitting, you're helping remote workers find great
                    places to be productive. Thank you! ðŸ™Œ
                </p>
                <button
                    id="paste"
                    type="button"
                    class="w-full bg-zinc-200 text-neutral-900 mb-4 py-4 font-black border-4 border-neutral-900 hover:bg-zinc-100 transition-colors shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-x-1 active:translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-neutral-300 disabled:text-neutral-500"
                    >SMART PASTE</button
                >
                <button
                    type="submit"
                    class="w-full bg-amber-500 text-neutral-900 py-4 font-black border-4 border-neutral-900 hover:bg-amber-400 transition-colors shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-x-1 active:translate-y-1"
                >
                    SUBMIT VENUE
                </button>
            </div>
            <input type="hidden" name="color" value="amber" />
            <input type="hidden" name="vibe" value="Good Vibe" />
            <input type="hidden" name="grade" value="D" />
        </form>
    </div>
</Layout>
<script>
    const pasteButton = document.querySelector("#paste");
    pasteButton.addEventListener("click", async () => {
        pasteButton.disabled = true;
        const text = await navigator.clipboard.readText();

        const response = await fetch("/api/generate", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                prompt: `Your purpose is to categorize and extract unstructured data about cafes from user input. Do not add any additional information or explanations. If no information is available for a field, you decide what to fill based on the text given. Field hours use this format: 07:00 - 22:00. Use short sentence to describe vibe field. For description field, write 1-2 sentences about workspace amenities, atmosphere, and unique features. For tags field, generate comma-separated keywords (no spaces after commas) related to the venue's amenities and characteristics. Choose color based on vibe, one of "emerald", "amber", "violet", or "orange". Then you grade based on the data, either 'A', 'B', 'C', or 'D'. Use English for all responses.

      Classify the following data:
      <user_data>
      ${text}
      </user_data>`,
                config: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            name: { type: "STRING" },
                            description: { type: "STRING" },
                            tags: { type: "STRING" },
                            address: { type: "STRING" },
                            hours: { type: "STRING" },
                            wifiScore: { type: "INTEGER" },
                            powerScore: { type: "INTEGER" },
                            noiseScore: { type: "INTEGER" },
                            seatingScore: { type: "INTEGER" },
                            vibe: { type: "STRING" },
                            color: { type: "STRING" },
                            url: { type: "STRING" },
                            grade: { type: "STRING" },
                        },
                    },
                },
            }),
        });

        const result = await response.json();

        if (result.status === "ok") {
            const parsed = JSON.parse(result.text.text);

            const nameInput = document.querySelector('input[name="name"]');
            const addressInput = document.querySelector(
                'input[name="address"]',
            );
            const hoursInput = document.querySelector('input[name="hours"]');
            const colorInput = document.querySelector('input[name="color"]');
            const vibeInput = document.querySelector('input[name="vibe"]');
            const gradeInput = document.querySelector('input[name="grade"]');

            const wifiScoreRange = document.querySelector(
                'input[name="wifiScore"]',
            );
            const powerScoreRange = document.querySelector(
                'input[name="powerScore"]',
            );
            const noiseScoreRange = document.querySelector(
                'input[name="noiseScore"]',
            );
            const seatingScoreRange = document.querySelector(
                'input[name="seatingScore"]',
            );
            const descriptionInput = document.querySelector(
                'textarea[name="description"]',
            );
            const tagsInput = document.querySelector('input[name="tags"]');

            nameInput.value = parsed.name || "";
            addressInput.value = parsed.address || "";
            descriptionInput.value = parsed.description || "";
            tagsInput.value = parsed.tags || "";
            hoursInput.value = parsed.hours || "";
            colorInput.value = parsed.color || "";
            vibeInput.value = parsed.vibe || "";
            gradeInput.value = parsed.grade || "D";
            wifiScoreRange.value = parsed.wifiScore || "3";
            powerScoreRange.value = parsed.powerScore || "3";
            noiseScoreRange.value = parsed.noiseScore || "3";
            seatingScoreRange.value = parsed.seatingScore || "3";
        }
        pasteButton.disabled = false;
    });
</script>
