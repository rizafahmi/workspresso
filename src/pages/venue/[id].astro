---
import { db, eq, Venue, Comment, desc } from "astro:db";
import Layout from "../../layouts/Layout.astro";
import ScoreCircle from "../../components/ScoreCircle.astro";
import { icons } from "../../components/icons";

const { id } = Astro.params;

const venue = await db
    .select()
    .from(Venue)
    .where(eq(Venue.id, Number(id)))
    .get();

if (!venue) {
    return {
        status: 404,
        body: "Venue not found",
    };
}

// Fetch comments for this venue
const comments = await db
    .select()
    .from(Comment)
    .where(eq(Comment.venueId, Number(id)))
    .orderBy(desc(Comment.created_at));
---

<Layout title={`Workspresso - ${venue.name}`}>
    <div class="min-h-screen bg-neutral-50">
        <div
            class="bg-neutral-950 text-white relative border-b-8 border-amber-500"
        >
            <div class="p-6">
                <a
                    href="/"
                    class="flex items-center text-white mb-6 hover:text-amber-400 transition-colors font-bold text-sm"
                >
                    <div class="w-5 h-5">
                        <Fragment set:html={icons.chevronLeft} />
                    </div>
                    BACK TO LIST
                </a>

                <div class="flex justify-between items-start mb-6">
                    <div class="flex-1">
                        <h1 class="text-3xl font-black mb-2 leading-tight">
                            {venue.name}
                        </h1>
                        <div class="text-sm text-gray-400 font-mono mb-3">
                            {venue.vibe}
                        </div>
                        {
                            venue.description && (
                                <p class="text-sm text-gray-300 leading-relaxed mb-3">
                                    {venue.description}
                                </p>
                            )
                        }
                        {
                            venue.tags && (
                                <div class="flex flex-wrap gap-1">
                                    {venue.tags.split(",").map((tag) => (
                                        <span class="text-xs px-2 py-1 bg-amber-500 text-neutral-900 font-mono font-bold">
                                            {tag}
                                        </span>
                                    ))}
                                </div>
                            )
                        }
                    </div>
                </div>

                <div class="flex justify-between items-center gap-4 pb-6">
                    <div class="text-center">
                        <ScoreCircle score={venue.wifiScore} />
                        <div class="text-xs font-bold mt-2">WI-FI</div>
                    </div>
                    <div class="text-center">
                        <ScoreCircle score={venue.powerScore} />
                        <div class="text-xs font-bold mt-2">POWER</div>
                    </div>
                    <div class="text-center">
                        <ScoreCircle score={venue.noiseScore} />
                        <div class="text-xs font-bold mt-2">NOISE</div>
                    </div>
                    <div class="text-center">
                        <ScoreCircle score={venue.seatingScore} />
                        <div class="text-xs font-bold mt-2">SPACE</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 space-y-4">
            <div
                class="bg-white border-4 border-neutral-900 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] overflow-hidden"
            >
                <div class="bg-neutral-900 text-white px-4 py-3">
                    <h2 class="font-black text-sm">WORK ENVIRONMENT</h2>
                </div>
                <div class="p-5 space-y-4">
                    <div
                        class="flex items-start gap-4 pb-4 border-b-2 border-neutral-200"
                    >
                        <div
                            class="w-12 h-12 bg-emerald-100 flex items-center justify-center border-2 border-neutral-900"
                        >
                            <div class="w-6 h-6 text-emerald-700">
                                <Fragment set:html={icons.wifi} />
                            </div>
                        </div>
                        <div class="flex-1">
                            <div
                                class="text-xs font-bold text-neutral-500 mb-1"
                            >
                                WI-FI RELIABILITY
                            </div>
                            <div class="text-lg font-black text-neutral-900">
                                {venue.wifiScore} / 5
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex items-start gap-4 pb-4 border-b-2 border-neutral-200"
                    >
                        <div
                            class="w-12 h-12 bg-amber-100 flex items-center justify-center border-2 border-neutral-900"
                        >
                            <div class="w-6 h-6 text-amber-700">
                                <Fragment set:html={icons.zap} />
                            </div>
                        </div>
                        <div class="flex-1">
                            <div
                                class="text-xs font-bold text-neutral-500 mb-1"
                            >
                                POWER OUTLETS
                            </div>
                            <div class="text-lg font-black text-neutral-900">
                                {venue.powerScore} / 5
                            </div>
                        </div>
                    </div>

                    <div
                        class="flex items-start gap-4 pb-4 border-b-2 border-neutral-200"
                    >
                        <div
                            class="w-12 h-12 bg-violet-100 flex items-center justify-center border-2 border-neutral-900"
                        >
                            <div class="w-6 h-6 text-violet-700">
                                <Fragment set:html={icons.volume2} />
                            </div>
                        </div>
                        <div class="flex-1">
                            <div
                                class="text-xs font-bold text-neutral-500 mb-1"
                            >
                                NOISE LEVEL
                            </div>
                            <div class="text-lg font-black text-neutral-900">
                                {venue.noiseScore} / 5
                            </div>
                        </div>
                    </div>

                    <div class="flex items-start gap-4">
                        <div
                            class="w-12 h-12 bg-blue-100 flex items-center justify-center border-2 border-neutral-900"
                        >
                            <div class="w-6 h-6 text-blue-700">
                                <Fragment set:html={icons.users} />
                            </div>
                        </div>
                        <div class="flex-1">
                            <div
                                class="text-xs font-bold text-neutral-500 mb-1"
                            >
                                SEATING & SPACE
                            </div>
                            <div class="text-lg font-black text-neutral-900">
                                {venue.seatingScore} / 5
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="bg-white border-4 border-neutral-900 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] overflow-hidden"
            >
                <div class="bg-neutral-900 text-white px-4 py-3">
                    <h2 class="font-black text-sm">LOCATION</h2>
                </div>
                <div class="p-5 space-y-4">
                    <div>
                        <div class="text-xs font-bold text-neutral-500 mb-1">
                            ADDRESS
                        </div>
                        <div class="font-bold text-neutral-900">
                            {venue.address}
                        </div>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-neutral-500 mb-1">
                            HOURS
                        </div>
                        <div class="font-bold text-neutral-900 font-mono">
                            {venue.hours}
                        </div>
                    </div>
                    <button
                        class="w-full bg-amber-500 text-neutral-900 py-4 font-black border-4 border-neutral-900 hover:bg-amber-400 transition-colors flex items-center justify-center gap-2 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-x-1 active:translate-y-1"
                    >
                        <div class="w-5 h-5">
                            <Fragment set:html={icons.navigation} />
                        </div>
                        GET DIRECTIONS
                    </button>
                </div>
            </div>

            <div
                id="feedback-received"
                class="hidden bg-white border-4 border-neutral-900 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] p-8 text-center"
            >
                <div
                    id="feedback-icon"
                    class="w-20 h-20 border-4 border-neutral-900 mx-auto flex items-center justify-center mb-4"
                >
                </div>
                <p class="font-black text-xl text-neutral-900 mb-2">
                    FEEDBACK RECEIVED
                </p>
                <p class="text-neutral-600 font-mono text-sm">
                    Thanks for helping us improve
                </p>
            </div>

            <!-- User Comments Section -->
            <div
                class="bg-white border-4 border-neutral-900 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] overflow-hidden"
            >
                <div class="bg-neutral-900 text-white px-4 py-3">
                    <h2 class="font-black text-sm">USER TESTIMONIALS</h2>
                </div>
                <div class="p-5">
                    {
                        venue.summary && (
                            <div class="mb-6 p-4 bg-amber-50 border-4 border-amber-400">
                                <div class="text-xs font-bold text-amber-800 mb-2">
                                    SUMMARY
                                </div>
                                <p class="text-neutral-900 font-bold">
                                    {venue.summary}
                                </p>
                            </div>
                        )
                    }
                    <!-- Comment Form -->
                    <form
                        id="comment-form"
                        class="mb-6 pb-6 border-b-2 border-neutral-200"
                    >
                        <h3 class="font-black text-neutral-900 mb-4">
                            SHARE YOUR EXPERIENCE
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label
                                    for="userName"
                                    class="block text-xs font-bold text-neutral-500 mb-1"
                                >
                                    YOUR NAME
                                </label>
                                <input
                                    type="text"
                                    id="userName"
                                    name="userName"
                                    required
                                    class="w-full px-4 py-3 border-4 border-neutral-900 font-bold text-neutral-900 focus:outline-none focus:border-amber-500"
                                    placeholder="Enter your name"
                                />
                            </div>
                            <div>
                                <label
                                    for="comment"
                                    class="block text-xs font-bold text-neutral-500 mb-1"
                                >
                                    YOUR COMMENT
                                </label>
                                <textarea
                                    id="comment"
                                    name="comment"
                                    required
                                    rows="4"
                                    class="w-full px-4 py-3 border-4 border-neutral-900 font-bold text-neutral-900 focus:outline-none focus:border-amber-500 resize-none"
                                    placeholder="Tell us about your experience..."
                                ></textarea>
                            </div>
                            <div>
                                <label
                                    for="fileUpload"
                                    class="block text-xs font-bold text-neutral-500 mb-1"
                                >
                                    UPLOAD IMAGE (OPTIONAL)
                                </label>
                                <input
                                    type="file"
                                    id="fileUpload"
                                    name="fileUpload"
                                    accept="image/*"
                                    class="w-full px-4 py-3 border-4 border-neutral-900 font-bold text-neutral-900 focus:outline-none focus:border-amber-500 file:mr-4 file:py-2 file:px-4 file:border-0 file:font-bold file:bg-amber-100 file:text-neutral-900 hover:file:bg-amber-200"
                                />
                            </div>
                            <button
                                type="submit"
                                class="w-full bg-amber-500 text-neutral-900 py-4 font-black border-4 border-neutral-900 hover:bg-amber-400 transition-colors shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-x-1 active:translate-y-1"
                            >
                                POST COMMENT
                            </button>
                        </div>
                    </form>

                    <!-- Success Message -->
                    <div
                        id="comment-success"
                        class="hidden mb-6 p-4 bg-emerald-100 border-4 border-emerald-700"
                    >
                        <p class="font-black text-emerald-900">
                            âœ“ Comment posted successfully!
                        </p>
                    </div>

                    <!-- Comments List -->
                    <div>
                        <h3 class="font-black text-neutral-900 mb-4">
                            COMMENTS ({comments.length})
                        </h3>
                        {
                            comments.length === 0 ? (
                                <div class="text-center py-8 text-neutral-500 font-mono">
                                    No comments yet. Be the first to share your
                                    experience!
                                </div>
                            ) : (
                                <div class="space-y-4">
                                    {comments.map((comment) => (
                                        <div
                                            class={`border-4 border-neutral-200 p-4 ${comment.sentiment === "positive" ? "!border-l-8 !border-emerald-500" : "!border-l-8 !border-red-500"}`}
                                        >
                                            <div class="flex items-start justify-between mb-2">
                                                <div class="font-black text-neutral-900">
                                                    {comment.userName}
                                                </div>
                                                <div class="text-xs text-neutral-500 font-mono">
                                                    {new Date(
                                                        comment.created_at,
                                                    ).toLocaleDateString()}
                                                </div>
                                            </div>
                                            <p class="text-neutral-700 mb-3">
                                                {comment.comment}
                                            </p>
                                            {comment.imageUrl && (
                                                <img
                                                    src={comment.imageUrl}
                                                    alt="Comment attachment"
                                                    class="max-w-full h-auto border-4 border-neutral-900 mt-3"
                                                />
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    // Headstart Gemini Nano
    const availability = await LanguageModel.availability();
    let session;
    if (availability !== "unavailable") {
        session = await startAISession();
    }
    const feedbackYes = document.getElementById("feedback-yes");
    const feedbackNo = document.getElementById("feedback-no");
    const feedbackSection = document.getElementById("feedback-section");
    const feedbackReceived = document.getElementById("feedback-received");
    const feedbackIcon = document.getElementById("feedback-icon");

    function handleFeedback(isPositive: boolean) {
        feedbackSection?.classList.add("hidden");
        feedbackReceived?.classList.remove("hidden");

        if (isPositive) {
            feedbackIcon?.classList.add("bg-emerald-500");
            feedbackIcon!.innerHTML =
                '<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"/></svg>';
        } else {
            feedbackIcon?.classList.add("bg-rose-500");
            feedbackIcon!.innerHTML =
                '<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"/></svg>';
        }
    }

    feedbackYes?.addEventListener("click", () => handleFeedback(true));
    feedbackNo?.addEventListener("click", () => handleFeedback(false));

    // Handle comment form submission
    const commentForm = document.getElementById(
        "comment-form",
    ) as HTMLFormElement;
    const commentSuccess = document.getElementById("comment-success");

    commentForm?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(commentForm);
        const userName = formData.get("userName") as string;
        const comment = formData.get("comment") as string;
        const fileUpload = formData.get("fileUpload") as File;
        const venueId = window.location.pathname.split("/").pop();
        // Let's analyze sentiment using Chrome's build in gemini nano
        const sentiment = (await analyzeSentiment(session, comment)) as string;

        let imageUrl = null;

        // Handle file upload if present
        if (fileUpload && fileUpload.size > 0) {
            const reader = new FileReader();
            const base64Promise = new Promise((resolve) => {
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(fileUpload);
            });
            imageUrl = await base64Promise;
        }

        try {
            const response = await fetch("/api/comments", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    venueId: Number(venueId),
                    userName,
                    comment,
                    sentiment,
                    imageUrl,
                }),
            });

            if (response.ok) {
                commentSuccess?.classList.remove("hidden");
                commentForm.reset();

                // Reload page after 1.5 seconds to show new comment
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                alert("Failed to post comment. Please try again.");
            }
        } catch (error) {
            console.error("Error posting comment:", error);
            alert("An error occurred. Please try again.");
        }
    });

    async function analyzeSentiment(session, comment) {
        const result = await session.prompt(`User: ${comment.trim()}`);
        console.log(result);

        return result;
    }

    async function startAISession() {
        const session = await LanguageModel.create({
            initialPrompts: [
                {
                    role: "system",
                    content: `Your job is to categorize whether text has a positive or negative sentiment. Just return either positive, negative or neutral. Here are some examples of text you might see:

                    User: I love this cafe!
                    Assistant: positive
                    User: Bagus sekali.
                    Assistant: positive
                    User: Kopinya pahit.
                    Assistant: negative
                    User: Meh..
                    Assistant: neutral
                    User: Could be better.
                    Assistant: neutral

                    Now it's your turn!
                    `,
                },
            ],
            monitor: (m) => {
                m.addEventListener("downloadprogress", (e) => {
                    console.info(`Downloaded ${e.loaded * 100}%`);
                });
            },
        });
        return session;
    }
</script>
